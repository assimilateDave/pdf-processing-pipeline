{% extends "base.html" %}

{% block title %}Model Management - PDF Processing Pipeline{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Model Management</h1>
        <p class="text-muted">Manage and train document classification models</p>
    </div>
</div>

<!-- Current Model Status -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-cpu"></i> Current Model Status</h5>
            </div>
            <div class="card-body">
                {% if classifier_info.trained %}
                    <div class="alert alert-success">
                        <i class="bi bi-check-circle"></i> Model is trained and ready
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-sm">
                                <tr><td><strong>Model Type:</strong></td><td>{{ classifier_info.model_type }}</td></tr>
                                <tr><td><strong>Vectorizer:</strong></td><td>{{ classifier_info.vectorizer_type }}</td></tr>
                                <tr><td><strong>Features:</strong></td><td>{{ classifier_info.feature_count }}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Available Categories:</h6>
                            <div>
                                {% for category in classifier_info.categories %}
                                    <span class="badge bg-primary me-1">{{ category }}</span>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle"></i> No model is currently trained
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Model Training -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-gear"></i> Train New Model</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Quick Training with Sample Data</h6>
                        <p class="text-muted">Train the model using built-in sample data for demonstration purposes.</p>
                        <button id="train-sample-model" class="btn btn-primary">
                            <i class="bi bi-play"></i> Train with Sample Data
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Upload Training Data</h6>
                        <p class="text-muted">Upload a CSV file with 'text' and 'category' columns.</p>
                        <div class="mb-3">
                            <input class="form-control" type="file" id="training-file" accept=".csv">
                        </div>
                        <button id="train-custom-model" class="btn btn-success" disabled>
                            <i class="bi bi-upload"></i> Train with Custom Data
                        </button>
                    </div>
                </div>
                
                <hr>
                
                <div id="training-progress" class="mt-3" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        <span>Training model...</span>
                    </div>
                </div>
                
                <div id="training-results" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Test Classification -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-pencil-square"></i> Test Classification</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="test-text" class="form-label">Enter text to classify:</label>
                    <textarea class="form-control" id="test-text" rows="5" placeholder="Enter document text here..."></textarea>
                </div>
                <button id="classify-text" class="btn btn-info">
                    <i class="bi bi-search"></i> Classify Text
                </button>
                
                <div id="classification-results" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- Sample Training Data Preview -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-table"></i> Sample Training Data</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Text Sample</th>
                                <th>Category</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sample in sample_data[:10] %}
                            <tr>
                                <td style="max-width: 400px;">
                                    {{ sample.text[:100] }}{% if sample.text|length > 100 %}...{% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ sample.category }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p class="text-muted mt-2">
                    <small>Showing 10 of {{ sample_data|length }} sample records</small>
                </p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    // Enable custom training button when file is selected
    $('#training-file').change(function() {
        $('#train-custom-model').prop('disabled', !this.files.length);
    });
    
    // Train with sample data
    $('#train-sample-model').click(function() {
        trainModel('sample');
    });
    
    // Train with custom data
    $('#train-custom-model').click(function() {
        trainModel('custom');
    });
    
    // Classify text
    $('#classify-text').click(function() {
        classifyText();
    });
});

function trainModel(type) {
    $('#training-progress').show();
    $('#training-results').empty();
    
    let button = type === 'sample' ? '#train-sample-model' : '#train-custom-model';
    $(button).prop('disabled', true);
    
    if (type === 'sample') {
        // Train with sample data
        $.ajax({
            url: '/api/train-model',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({}),
            success: function(response) {
                displayTrainingResults(response);
            },
            error: function() {
                displayTrainingResults({success: false, error: 'Training request failed'});
            },
            complete: function() {
                $('#training-progress').hide();
                $(button).prop('disabled', false);
            }
        });
    } else {
        // Handle custom file upload (would need additional implementation)
        alert('Custom file training would be implemented here');
        $('#training-progress').hide();
        $(button).prop('disabled', false);
    }
}

function displayTrainingResults(response) {
    let html = '';
    
    if (response.success) {
        html = `
            <div class="alert alert-success">
                <h6><i class="bi bi-check-circle"></i> Training Completed Successfully!</h6>
                <ul class="mb-0">
                    <li>Accuracy: ${(response.accuracy * 100).toFixed(1)}%</li>
                    <li>Training samples: ${response.training_samples}</li>
                    <li>Test samples: ${response.test_samples}</li>
                    <li>Categories: ${response.categories.join(', ')}</li>
                </ul>
            </div>
        `;
        
        // Show detailed metrics if available
        if (response.classification_report) {
            html += '<h6>Detailed Metrics:</h6>';
            html += '<div class="table-responsive">';
            html += '<table class="table table-sm">';
            html += '<thead><tr><th>Category</th><th>Precision</th><th>Recall</th><th>F1-Score</th><th>Support</th></tr></thead>';
            html += '<tbody>';
            
            for (let category in response.classification_report) {
                if (category !== 'accuracy' && category !== 'macro avg' && category !== 'weighted avg') {
                    let metrics = response.classification_report[category];
                    if (typeof metrics === 'object') {
                        html += `
                            <tr>
                                <td>${category}</td>
                                <td>${(metrics.precision * 100).toFixed(1)}%</td>
                                <td>${(metrics.recall * 100).toFixed(1)}%</td>
                                <td>${(metrics['f1-score'] * 100).toFixed(1)}%</td>
                                <td>${metrics.support}</td>
                            </tr>
                        `;
                    }
                }
            }
            
            html += '</tbody></table></div>';
        }
    } else {
        html = `
            <div class="alert alert-danger">
                <h6><i class="bi bi-x-circle"></i> Training Failed</h6>
                <p class="mb-0">Error: ${response.error}</p>
            </div>
        `;
    }
    
    $('#training-results').html(html);
}

function classifyText() {
    let text = $('#test-text').val().trim();
    
    if (!text) {
        alert('Please enter some text to classify');
        return;
    }
    
    $('#classify-text').prop('disabled', true);
    
    $.ajax({
        url: '/api/classify-text',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({text: text}),
        success: function(response) {
            displayClassificationResults(response);
        },
        error: function() {
            displayClassificationResults({success: false, error: 'Classification request failed'});
        },
        complete: function() {
            $('#classify-text').prop('disabled', false);
        }
    });
}

function displayClassificationResults(response) {
    let html = '';
    
    if (response.success) {
        let classification = response.classification;
        
        html = `
            <div class="alert alert-info">
                <h6><i class="bi bi-tag"></i> Classification Result</h6>
                <p><strong>Category:</strong> <span class="badge bg-primary">${classification.category}</span></p>
                <p><strong>Confidence:</strong> ${(classification.confidence * 100).toFixed(1)}%</p>
            </div>
        `;
        
        if (classification.probabilities) {
            html += '<h6>All Category Probabilities:</h6>';
            html += '<div class="row">';
            
            // Sort probabilities by value
            let sortedProbs = Object.entries(classification.probabilities)
                .sort(([,a], [,b]) => b - a);
            
            for (let [category, prob] of sortedProbs) {
                html += `
                    <div class="col-md-4 mb-2">
                        <div class="d-flex justify-content-between">
                            <span>${category}:</span>
                            <span>${(prob * 100).toFixed(1)}%</span>
                        </div>
                        <div class="progress" style="height: 15px;">
                            <div class="progress-bar ${category === classification.category ? 'bg-primary' : 'bg-secondary'}" 
                                 style="width: ${prob * 100}%"></div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
        }
    } else {
        html = `
            <div class="alert alert-danger">
                <h6><i class="bi bi-x-circle"></i> Classification Failed</h6>
                <p class="mb-0">Error: ${response.error}</p>
            </div>
        `;
    }
    
    $('#classification-results').html(html);
}
</script>
{% endblock %}